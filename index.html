<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港水質監測系統</title>

    <!-- TGOS Map API -->
    <script type="text/javascript" 
        src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" 
        charset="utf-8"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin:0; font-family:"Microsoft JhengHei", sans-serif; display:flex; height:100vh; width:100vw; overflow:hidden; }
        #MapDiv { flex:1; height:100%; }
        #controlPanel {
            width:400px;
            height:100%;
            background:#fff;
            padding:20px;
            box-sizing:border-box;
            overflow-y:auto;
            border-left:1px solid #ccc;
        }
        h3 { color:#1a73e8; border-bottom:2px solid #1a73e8; padding-bottom:8px; margin-top:0; }
        .row { margin-bottom:20px; }
        select, button { width:100%; padding:8px; font-size:16px; }
        .chart-container { position:relative; height:200px; width:100%; margin-bottom:20px; }
    </style>
</head>
<body onload="InitAll();">

    <div id="MapDiv"></div>

    <div id="controlPanel">
        <h3>漁港水質監測</h3>
        <div class="row">
            <label>選擇監測漁港：</label>
            <select id="portSelect" onchange="onPortChange()">
                <option value="">-- 請選擇漁港 --</option>
            </select>
        </div>

        <div class="row">
            <b>目前選擇：</b> <span id="currentPort">無</span>
        </div>

        <div class="row chart-container">
            <canvas id="phChart"></canvas>
        </div>
        <div class="row chart-container">
            <canvas id="doChart"></canvas>
        </div>
    </div>

<script>
var map = null;
var csvData = [];
var markers = {};
var phChart = null, doChart = null;

// 14 個漁港座標 (TWD97)
var portsCoords = {
    "梗枋漁港": { x: 337764.335, y: 2755398.563 },
    "烏石港": { x: 334239.940, y: 27550843.053 },
    "大溪第一漁港": { x: 340745.390, y: 2759584.125 },
    "大溪第二漁港": { x: 340813.356, y: 2759507.712 },
    "蕃薯寮漁港": { x: 342395.941, y: 2760783.203 },
    "大里漁港": { x: 343045.640, y: 27619286.964 },
    "石城漁港": { x: 346013.905, y: 2763893.910 },
    "桶盤堀漁港": { x: 344532.179, y: 2763169.322 },
    "蘇澳港": { x: 337596.057, y: 2720381.909 },
    "南方澳第三漁港": { x: 337721.962, y: 2719959.266 },
    "南方澳第一漁港": { x: 337866.597, y: 2719772.307 },
    "南方澳第二漁港": { x: 337940.522, y: 2719273.154 },
    "粉鳥林漁港": { x: 335482.954, y: 2710393.202 },
    "朝陽漁港": { x: 333150.115, y: 2706340.334 }
};

function InitAll() {
    fetch('water_quality.csv?t=' + Date.now())
        .then(res => res.text())
        .then(text => {
            csvData = Papa.parse(text.trim(), { header:true, skipEmptyLines:true, dynamicTyping:true }).data;
            updateDropdown();
            initMap();
        })
        .catch(err => {
            console.error("CSV 讀取失敗", err);
            alert("無法載入 CSV，請確認檔案存在。");
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- 請選擇漁港 --</option>';
    Object.keys(portsCoords).sort().forEach(name => {
        var opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
    });
}

function initMap() {
    var mapDiv = document.getElementById("MapDiv");
    var startPt = new TGOS.TGPoint(334358.5, 2750928.9); // 預設烏石港
    map = new TGOS.TGOnlineMap(mapDiv, TGOS.TGCoordSys.EPSG3826, {
        zoom: 13,
        navigationControl: true,
        navigationControlOptions: {
            controlPosition: TGOS.TGControlPosition.TOP_LEFT,
            navigationControlStyle: TGOS.TGNavigationControlStyle.SMALL
        }
    });
    map.setCenter(startPt);
    createMarkers();
}

function createMarkers() {
    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38,33));
    Object.keys(portsCoords).forEach(name => {
        var pt = new TGOS.TGPoint(portsCoords[name].x, portsCoords[name].y);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        TGOS.TGEvent.addListener(mk, "click", function() {
            document.getElementById('currentPort').textContent = name;
            document.getElementById('portSelect').value = name;
            map.setCenter(pt);
            drawChartsForPort(name);
        });
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (!name) return;
    document.getElementById('currentPort').textContent = name;
    if (markers[name]) map.setCenter(markers[name].getPosition());
    drawChartsForPort(name);
}

function getPortData(portName) {
    return csvData.filter(r => String(r.port).trim() === portName)
                  .sort((a,b) => (a.year*100+a.month)-(b.year*100+b.month));
}

function drawChartsForPort(portName) {
    var rows = getPortData(portName);
    if (!rows || rows.length===0) return;
    var labels = rows.map(r => r.year + "/" + r.month);
    var phValues = rows.map(r => r.ph);
    var doValues = rows.map(r => r.do);

    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: { labels: labels, datasets:[{ label: 'pH', data: phValues, borderColor:'orange', fill:false }]},
        options:{ maintainAspectRatio:false }
    });

    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: { labels: labels, datasets:[{ label: 'DO (mg/L)', data: doValues, borderColor:'blue', fill:false }]},
        options:{ maintainAspectRatio:false }
    });
}
</script>
</body>

</html>

